---
buildifier:
  version: 4.0.1
  # Check for issues with the format of our bazel config files.
  # All warnings from https://github.com/bazelbuild/buildtools/blob/master/WARNINGS.md
  # are enabled except:
  # rule-impl-return, uninitialized, return-value, rule-impl-return
  # TODO (suvanjan): Re-enable once issues are fixed.
  warnings: "attr-cfg,attr-license,attr-non-empty,attr-output-default,attr-single-file,confusing-name,constant-glob,ctx-actions,ctx-args,depset-iteration,depset-union,dict-concatenation,duplicated-name,filetype,function-docstring,git-repository,http-archive,integer-division,load,load-on-top,module-docstring,name-conventions,native-build,native-package,no-effect,out-of-order-load,output-group,package-name,package-on-top,redefined-variable,repository-name,same-origin-load,string-iteration,unreachable,unsorted-dict-items,unused-variable"
bazel: 3.5.0 # keep in sync with .bazelversion
tasks:
  default_workspace_ubuntu1804:
    platform: ubuntu1804
    test_targets:
      - //...
    test_flags:
      - --config=buildkite
  # TODO(user): re-enable testing on macos.
  # default_workspace_macos:
  #   platform: macos
  #   test_targets:
  #     - //...
  #   test_flags:
  #     - --config=buildkite
  #     - --deleted_packages=tests/contrib,tests/docker/util
  testing_examples:
    platform: ubuntu1804
    working_directory: testing/examples
    shell_commands:
      - cp ../../.bazelrc .
    test_targets:
      - //basic:all
      - //extended:all
      - //java_app:all
      - //run_instruction_apt_pkgs:all
      - //run_instruction_arbitrary:all
    test_flags:
      - --test_output=errors
  testing_java_image:
    platform: ubuntu1804
    working_directory: testing/java_image
    shell_commands:
      - cp ../../.bazelrc .
    build_targets:
      - //...
  testing_download_pkgs_at_root:
    platform: ubuntu1804
    working_directory: testing/download_pkgs_at_root
    shell_commands:
      - cp ../../.bazelrc .
    test_targets:
      - //...
    test_flags:
      - --test_output=errors
  testing_custom_toolchain_flags:
    platform: ubuntu1804
    working_directory: testing/custom_toolchain_flags
    shell_commands:
      - cp ../../.bazelrc .
    test_targets:
      - //...
    test_flags:
      - --test_output=errors
